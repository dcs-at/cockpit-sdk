"use strict";var _createClass=function(){function n(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(e,t,i){return t&&n(e.prototype,t),i&&n(e,i),e}}();function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var WebSocket=require("universal-websocket-client"),CockpitRealTime=function(){function o(e){var t=e.host,i=e.protocol,n=void 0===i?"refresh-protocol":i;_classCallCheck(this,o),this.websocket=new WebSocket(t,n)}return _createClass(o,[{key:"on",value:function(i,n,e){o.isValidEvent(i)?(this.websocket.addEventListener("message",function(e){var t=JSON.parse(e.data);t.event.replace(o.eventPrefix,"")===i&&n(Object.assign({},t,{event:t.event}))}),this.websocket.addEventListener("error",e)):console.warn("Invalid event:",i)}}],[{key:"isValidEvent",value:function(e){return!!e&&(!!Object.values(o.events).includes(e)||Object.values(o.events).filter(function(e){return e.includes(".%s")}).map(function(e){return e.replace(".%s","")}).includes(e.split(".").slice(0,-1).join(".")))}}]),o}();CockpitRealTime.events={CONNECT:"connect",REGIONS_SAVE_AFTER:"regions.save.after",REGIONS_REMOVE_AFTER:"regions.remove.after",COLLECTIONS_SAVE_AFTER:"collections.save.after",COLLECTIONS_SAVE_AFTER_NAME:"collections.save.after.%s",COLLECTIONS_REMOVE_AFTER:"collections.remove.after",COLLECTIONS_PREVIEW:"collections.preview"},CockpitRealTime.eventPrefix="cockpit:",module.exports=CockpitRealTime,Object.defineProperty(exports,"__esModule",{value:!0});var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},_queryString=(_createClass=function(){function n(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(e,t,i){return t&&n(e.prototype,t),i&&n(e,i),e}}(),require("query-string")),_queryString2=_interopRequireDefault(_queryString),_isomorphicFetch=require("isomorphic-fetch"),_isomorphicFetch2=_interopRequireDefault(_isomorphicFetch),_CockpitRealTime2=_interopRequireDefault(_CockpitRealTime=require("./CockpitRealTime"));function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _objectWithoutProperties(e,t){var i={};for(var n in e)0<=t.indexOf(n)||Object.prototype.hasOwnProperty.call(e,n)&&(i[n]=e[n]);return i}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var CockpitSDK=function(){function u(e){var t=e.accessToken,i=e.defaultOptions,n=e.fetchInitOptions,o=e.host,a=e.lang,r=e.webSocket,c=_objectWithoutProperties(e,["accessToken","defaultOptions","fetchInitOptions","host","lang","webSocket"]);_classCallCheck(this,u),this.defaultOptions={},this.fetchInitOptions={mode:"cors",cache:"default"},this.getImageOptions=function(e){return"number"==typeof e?{width:e}:e};var s=Object.keys(c);s.length&&console.error("Invalid keys:",s,"\n","Valid keys are:","accessToken, defaultOptions, fetchInitOptions, host, lang, webSocket"),this.host=o,this.lang=a,this.fetchInitOptions=Object.assign({},this.fetchInitOptions,n),this.defaultOptions=Object.assign({},this.defaultOptions,i),this.accessToken=t,this.webSocket=r,this.queryParams={lang:this.lang,token:this.accessToken},r&&this.setWebsocket(r)}return _createClass(u,[{key:"fetchData",value:function(e,t,i){var n=Object.assign({},t,this.fetchInitOptions),o=""+this.host+e+"?"+_queryString2.default.stringify(this.queryParams)+"&"+_queryString2.default.stringify(i);return(0,_isomorphicFetch2.default)(o,n).then(function(e){return e.json()})}},{key:"fetchDataText",value:function(e,t,i){var n=Object.assign({},t,this.fetchInitOptions),o=""+this.host+e+"?"+_queryString2.default.stringify(this.queryParams)+"&"+_queryString2.default.stringify(i);return(0,_isomorphicFetch2.default)(o,n).then(function(e){return e.text()})}},{key:"collectionSchema",value:function(e){return this.fetchData("/api/collections/collection/"+e,{method:"GET"})}},{key:"collectionList",value:function(){return this.fetchData("/api/collections/listCollections",{method:"GET"})}},{key:"collectionGet",value:function(e,t){return this.fetchData("/api/collections/get/"+e,{method:"POST",headers:{"Content-Type":"application/json"},body:this.stringifyOptions(t)})}},{key:"collectionSave",value:function(e,t){return this.fetchData("/api/collections/save/"+e,{method:"POST",headers:{"Content-Type":"application/json"},body:this.stringifyOptions({data:t})})}},{key:"collectionRemove",value:function(e,t){return this.fetchData("/api/collections/remove/"+e,{method:"POST",headers:{"Content-Type":"application/json"},filter:this.stringifyOptions(t)})}},{key:"stringifyOptions",value:function(e){return JSON.stringify(Object.assign({},this.defaultOptions,e))}},{key:"collection",value:function(n,o){var a=this;return{get:function(e,t){a.collectionGet(n,o).then(e).catch(t)},promise:new Promise(function(e,t){a.collectionGet(n,o).then(e).catch(t)}),schema:function(e,t){a.collectionSchema(n,o).then(e).catch(t)},watch:function(e,t){var i=function(){return a.collectionGet(n,o).then(e).catch(t)};i(),a.webSocket&&(a.webSocket.on(_CockpitRealTime2.default.events.COLLECTIONS_SAVE_AFTER,i,t),a.webSocket.on(_CockpitRealTime2.default.events.COLLECTIONS_SAVE_AFTER+"."+n,i,t))},on:function(e,t,i){var n={save:_CockpitRealTime2.default.events.COLLECTIONS_SAVE_AFTER,preview:_CockpitRealTime2.default.events.COLLECTIONS_PREVIEW};a.webSocket&&a.webSocket.on(n[e],t,i)}}}},{key:"regionGet",value:function(e){return this.fetchDataText("/api/regions/get/"+e,{method:"GET"})}},{key:"regionList",value:function(){return this.fetchData("/api/regions/listRegions",{method:"GET"})}},{key:"regionData",value:function(e){return this.fetchData("/api/regions/data/"+e,{method:"GET"})}},{key:"region",value:function(i){var n=this;return{data:function(e,t){n.regionData(i).then(e).catch(t)},get:function(e,t){n.regionGet(i).then(e).catch(t)}}}},{key:"pageGet",value:function(e){return this.fetchDataText("/api/pages/get/"+e,{method:"GET"})}},{key:"pageList",value:function(){return this.fetchData("/api/pages/listPages",{method:"GET"})}},{key:"pageData",value:function(e){return this.fetchData("/api/pages/data/"+e,{method:"GET"})}},{key:"page",value:function(i){var n=this;return{data:function(e,t){n.pageData(i).then(e).catch(t)},get:function(e,t){n.pageGet(i).then(e).catch(t)}}}},{key:"assets",value:function(e){return this.fetchData("/api/cockpit/assets",{method:"GET",headers:{"Content-Type":"application/json"}},e)}},{key:"imageGet",value:function(e,t){var i=t.width,n=t.height,o=t.quality;return this.fetchDataText("/api/cockpit/image",{method:"GET"},{src:e,w:i,h:n,q:o,d:1})}},{key:"image",value:function(e,t){if(!t||t==={}||t===[])return this.host+"/"+e;if(Array.isArray(t))return this.imageSrcSet(e,t);var i=this.getImageOptions(t),n=i.width,o=i.height,a=i.quality,r=_objectWithoutProperties(i,["width","height","quality"]);return this.host+"/api/cockpit/image?"+_queryString2.default.stringify(Object.assign({},this.queryParams,{src:e,w:n,h:o,q:a,d:1,o:1},r))}},{key:"imageSrcSet",value:function(t){var i=this,e=1<arguments.length&&void 0!==arguments[1]?arguments[1]:[];return e?e.map(function(e){return"object"===(void 0===e?"undefined":_typeof(e))?i.image(t,{width:e.width})+" "+(e.srcSet||e.width?e.width+"w":""):i.image(t,{width:e})+" "+e+"w"}).join(", "):""}},{key:"authUser",value:function(e,t){return this.fetchData("/api/cockpit/authUser",{method:"POST",headers:{"Content-Type":"application/json"},body:this.stringifyOptions({user:e,password:t})})}},{key:"listUsers",value:function(e){return this.fetchData("/api/cockpit/listUsers",{method:"GET",headers:{"Content-Type":"application/json"}},e)}},{key:"setWebsocket",value:function(e){this.webSocket=new _CockpitRealTime2.default({host:e})}}]),u}();CockpitSDK.events={SAVE:"save",PREVIEW:"preview"},exports.default=CockpitSDK,Object.defineProperty(exports,"__esModule",{value:!0}),exports.CockpitRealTime=void 0;_CockpitRealTime2=_interopRequireDefault(_CockpitRealTime=require("./CockpitRealTime"));var _CockpitRealTime,_CockpitSDK=require("./CockpitSDK"),_CockpitSDK2=_interopRequireDefault(_CockpitSDK);function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}exports.default=_CockpitSDK2.default,exports.CockpitRealTime=_CockpitRealTime2.default;